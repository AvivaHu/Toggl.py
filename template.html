<html>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Time logger report</title>
    <head>
    <style>
body {
    background-color:FFF;
}
#header{
    font-size:32px;
    margin-bottom:130px;
}
#container {
    max-width: 1600px;
    min-width: 1300px;
}

.course {
    #margin: 15px 0;
}
.header {
    font-size:24px;
    margin-top:3em;
}
.chart {
}

.table {
}

    </style>
</head>
<body>
<div id='header'>Time logger report</div>
<div id="container">


</div>


<script src="https://www.google.com/jsapi"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script>

    var week_labels = %(week_labels)s;
    var report_data = %(report_data)s;
    var teams = %(teams)s;
    var courses = %(courses)s;

    google.load("visualization", "1", {packages:["table", "corechart"]});
    google.setOnLoadCallback(drawChart);

    function drawChart() {

        // Spring Break workaround to not count it in the total number of weeks in Average
        var spring_break_idx = week_labels.indexOf("Mar 09");
        if (spring_break_idx < 0) spring_break_idx = 100;

        week_labels.push('Avg');

        courses.forEach(function(course, index){
            // get teams who have this course
            // for all weeks, for a given team,
            $('#container').append("<div class='"+index+"' id='"+course+"-container'>" +
                                        "<div class='header' id='"+course+"-header'>" + course + "</div>" +
                                        "<div class='chart' id='"+course+"-chart'>" + "</div>" +
                                        "<div class='table' id='"+course+"-table'>" + "</div>" +
                                    "</div>");

            // Tables
            var data = new google.visualization.DataTable();
            data.addColumn('string', 'Team');
            week_labels.forEach(function(week){
                data.addColumn('number', week);
            });

            teams.forEach(function(team) {
                if (report_data[course].hasOwnProperty(team)) {
                    var avg=0, total_weeks = 0;
                    report_data[course][team].slice(0).reverse().forEach(function(datapoint){
                        if (total_weeks > 0 || datapoint > 0) {
                            total_weeks++;
                            avg += datapoint;
                        }
                    })

                    // spring break workaround
                    if (total_weeks >= spring_break_idx)  total_weeks--;

                    report_data[course][team].push(Math.round(100*avg/total_weeks)/100);
                    var row = [team];
                    data.addRow(row.concat(report_data[course][team]));
                }
            })

            var table = new google.visualization.Table(document.getElementById(course+'-table'));
            table.draw(data, {showRowNumber: false});

            // Charts

            data = new google.visualization.DataTable();
            data.addColumn('string', 'Week');
            teams.forEach(function(team) {
                if (report_data[course].hasOwnProperty(team)) {
                    data.addColumn('number', team);
                }
            });

            for (var i=0; i< week_labels.length; i++) {
                week = week_labels[i];
                var row = [week];
                teams.forEach(function(team) {
                    if (report_data[course].hasOwnProperty(team)) {
                        row.push(report_data[course][team][i]);
                    }
                });
                data.addRow(row);
            }


            var options = {
                chartArea: {left:'5%%',top:'5%%',width:'75%%',height:'85%%'},
                pointShape: 'square',
                pointSize: 15,
                width: 1100,
                height: 430
            };

            var chart = new google.visualization.LineChart(document.getElementById(course+'-chart'));
            chart.draw(data, options);

        });

    }
</script>

</body></html>
